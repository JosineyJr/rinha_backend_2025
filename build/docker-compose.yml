services:
  api-01:
    build:
      context: ../ 
      dockerfile: ./build/Dockerfile # Point to the Dockerfile within the build folder
    hostname: rinha-api-dev-01
    networks:
      - payment-processor
      - backend
    environment:
      - PAYMENT_PROCESSOR_URL_DEFAULT=http://payment-processor-default:8080
      - PAYMENT_PROCESSOR_URL_FALLBACK=http://payment-processor-fallback:8080
      - INFLUXDB_URL=http://rinha-influxdb-dev:8086
      - INFLUXDB_ADMIN_TOKEN=4qooWJYOHSDdqnzs9vW9Xoxn3QZbS6yd5inEwM4JC8RERi0J-Kn9ALYG5Ppi0vZMYHBf_necJIYFsKhNR2Ib9g==
      - INFLUXDB_ORG=my-org
      - INFLUXDB_BUCKET=payments-summary
      - INFLUXDB_USERNAME=myuser
      - INFLUXDB_PASSWORD=mysupersecretpassword
      - PORT=9998
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "125MB"

  api-02:
    build:
      context: ../ 
      dockerfile: ./build/Dockerfile # Point to the Dockerfile within the build folder
    hostname: rinha-api-dev-02
    networks:
      - payment-processor
      - backend
    environment:
      - PAYMENT_PROCESSOR_URL_DEFAULT=http://payment-processor-default:8080
      - PAYMENT_PROCESSOR_URL_FALLBACK=http://payment-processor-fallback:8080
      - INFLUXDB_URL=http://rinha-influxdb-dev:8086
      - INFLUXDB_ADMIN_TOKEN=4qooWJYOHSDdqnzs9vW9Xoxn3QZbS6yd5inEwM4JC8RERi0J-Kn9ALYG5Ppi0vZMYHBf_necJIYFsKhNR2Ib9g==
      - INFLUXDB_ORG=my-org
      - INFLUXDB_BUCKET=payments-summary
      - INFLUXDB_USERNAME=myuser
      - INFLUXDB_PASSWORD=mysupersecretpassword
      - PORT=9997
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "125MB"

  influxdb:
      image: influxdb:2.7
      container_name: rinha-influxdb-dev
      ports:
        - "8086:8086"
      volumes:
        - ./influxdb/data:/var/lib/influxdb2
        - ./influxdb/init.sh:/docker-entrypoint-initdb.d/init.sh
      environment:
        - DOCKER_INFLUXDB_INIT_MODE=setup
        - DOCKER_INFLUXDB_INIT_USERNAME=myuser
        - DOCKER_INFLUXDB_INIT_PASSWORD=mysupersecretpassword
        - DOCKER_INFLUXDB_INIT_ORG=my-org
        - DOCKER_INFLUXDB_INIT_BUCKET=payments-summary
        - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=4qooWJYOHSDdqnzs9vW9Xoxn3QZbS6yd5inEwM4JC8RERi0J-Kn9ALYG5Ppi0vZMYHBf_necJIYFsKhNR2Ib9g==
      networks:
        - backend
      deploy:
        resources:
          limits:
            cpus: "0.25"
            memory: "50MB"
  nginx:
      image: nginx:latest
      container_name: lb
      volumes:
        - ./nginx.conf:/etc/nginx/nginx.conf:ro
      ports:
        - "9999:9999"
      depends_on:
        - api-01
        - api-02
      networks:
        - backend
      deploy:
        resources:
          limits:
            cpus: "0.25"
            memory: "50MB"

networks:
  backend:
    driver: bridge
  payment-processor:
    external: true